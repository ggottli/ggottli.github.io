<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Euchre League</title>
  <!-- Supabase JS (ESM) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main id="app">
    <!-- LOGIN -->
    <section id="login" class="section">
      <h1>THG Euchre League</h1>
      <div class="field">
        <label for="loginName">Name:</label>
        <input type="text" id="loginName" placeholder="First Last" required />
      </div>
      <div class="field">
        <label for="loginEmail">Email:</label>
        <input type="email" id="loginEmail" placeholder="you@heritage.com" required />
      </div>
      <button id="loginBtn">Log In</button>
      <p id="loginMsg" class="error"></p>
    </section>

    <!-- LEAGUE SELECTION -->
    <section id="join" class="section hidden">
      <h2>Welcome, <span id="tempName"></span>!</h2>
      <div class="field">
        <label for="leagueSelect">League:</label>
        <select id="leagueSelect">
          <option value="competitive">Competitive</option>
          <option value="casual">Casual</option>
        </select>
      </div>
      <button id="joinBtn">Join League</button>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="section hidden">
      <header class="dashboard-header">
        <h2>Welcome, <span id="userName"></span>!</h2>
        <button id="logoutBtn" class="danger">Logout</button>
      </header>
      <nav class="tabs">
        <button data-tab="pairings" class="tab active">Pairings</button>
        <button data-tab="scores" class="tab">Enter Scores</button>
        <button data-tab="history" class="tab">History</button>
        <button data-tab="leaderboard" class="tab">Leaderboard</button>
        <button data-tab="admin" id="adminTab" class="tab hidden">Admin</button>
      </nav>
      <div id="content" class="content-area"></div>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // Initialize Supabase
    const SUPA_URL = 'https://didwbzlecssxmaohjyqe.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpZHdiemxlY3NzeG1hb2hqeXFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAyNTY1OTAsImV4cCI6MjA2NTgzMjU5MH0.VP07HMW5-s3Q2ewAluufQz5oPDHtfTAEguadFY3inT4';
    const supabase = createClient(SUPA_URL, SUPA_KEY);

    // Shortcuts
    const $ = selector => document.querySelector(selector);
    const $all = selector => Array.from(document.querySelectorAll(selector));

    // Sections & Elements
    const loginSec = $('#login');
    const joinSec = $('#join');
    const dashSec = $('#dashboard');
    const loginMsg = $('#loginMsg');
    const tempName = $('#tempName');
    const userName = $('#userName');
    const content = $('#content');
    const adminTab = $('#adminTab');

    let currentUser = null;

    // Show/hide sections
    function showSection(id) {
      [loginSec, joinSec, dashSec].forEach(sec => {
        sec.classList.toggle('hidden', sec.id !== id);
      });
    }

    // Tab navigation
    function selectTab(tab) {
      $all('.tab').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
      content.innerHTML = '';
      switch(tab) {
        case 'pairings': loadPairings(); break;
        case 'scores': loadScoreEntry(); break;
        case 'history': loadHistory(); break;
        case 'leaderboard': loadLeaderboard(); break;
        case 'admin': loadAdmin(); break;
      }
    }

    // Event listeners
    $('#loginBtn').addEventListener('click', handleLogin);
    $('#joinBtn').addEventListener('click', handleJoin);
    $('#logoutBtn').addEventListener('click', handleLogout);
    $all('.tab').forEach(btn => btn.addEventListener('click', () => selectTab(btn.dataset.tab)));

    // Handle login
    async function handleLogin() {
      const name = $('#loginName').value.trim();
      const email = $('#loginEmail').value.trim();
      if (!name || !email) {
        loginMsg.textContent = 'Please enter both name and email.';
        return;
      }
      loginMsg.textContent = '';
      // Admin bypass
      if (name.toLowerCase() === 'admin' && email.toLowerCase() === 'admin') {
        currentUser = { id: 'admin', name: 'Admin', email: 'admin', role: 'admin' };
        setupDashboard();
        return;
      }
      // Regular user flow
      const { data: user, error } = await supabase
        .from('users')
        .select('id,name,league')
        .eq('email', email)
        .maybeSingle();
      if (error) {
        loginMsg.textContent = error.message;
        return;
      }
      if (user) {
        currentUser = { ...user, email };
      } else {
        currentUser = { name, email };
        tempName.textContent = name;
        showSection('join');
        return;
      }
      setupDashboard();
    }

    function setupDashboard() {
      userName.textContent = currentUser.name;
      // reveal admin tab if admin
      if (currentUser.role === 'admin') {
        adminTab.classList.remove('hidden');
      }
      showSection('dashboard');
      selectTab(currentUser.role === 'admin' ? 'admin' : 'pairings');
    }

    // Handle league join
    async function handleJoin() {
      const league = $('#leagueSelect').value;
      const { data, error } = await supabase
        .from('users')
        .insert({ name: currentUser.name, email: currentUser.email, league })
        .select('id,name,league')
        .single();
      if (error) {
        alert('Error creating user: ' + error.message);
        return;
      }
      currentUser = data;
      setupDashboard();
    }

    // Handle logout
    function handleLogout() {
      currentUser = null;
      $('#loginName').value = '';
      $('#loginEmail').value = '';
      adminTab.classList.add('hidden');
      showSection('login');
    }

    // --- Tab Content Functions ---
    async function loadPairings() {
      // existing logic...
    }
    async function loadScoreEntry() {
      // existing logic...
    }
    async function loadHistory() {
      // existing logic...
    }
    async function loadLeaderboard() {
      // existing logic...
    }

    // Admin panel
    async function loadAdmin() {
      content.innerHTML = `
        <div class="card">
          <h4>Admin Controls</h4>
          <button id="genPair">Generate Pairings</button>
          <button id="viewAllPair">View All Pairings</button>
          <button id="editScores">Edit All Scores</button>
        </div>
      `;
      document.getElementById('genPair').onclick = async () => {
        // call edge function
        const { data, error } = await supabase.functions.invoke('generatePairings');
        alert(error ? error.message : 'Pairings generated successfully');
      };
      document.getElementById('viewAllPair').onclick = async () => {
        const { data: all } = await supabase.from('matchups').select('*').order('week');
        content.innerHTML += `<pre>${JSON.stringify(all, null, 2)}</pre>`;
      };
      document.getElementById('editScores').onclick = () => {
        selectTab('scores');
      };
    }

    // Initial view
    showSection('login');
  </script>
