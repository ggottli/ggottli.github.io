<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Euchre - 4 Player</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+3:wght@400;500;600&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --felt-dark: #0a1f12;
                --felt-main: #1a4d2e;
                --felt-light: #2d6b44;
                --gold: #d4af37;
                --gold-light: #f4d03f;
                --gold-dark: #b8860b;
                --card-shadow:
                    0 4px 12px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);
                --card-hover-shadow:
                    0 12px 28px rgba(212, 175, 55, 0.3),
                    0 8px 16px rgba(0, 0, 0, 0.4);
                --panel-bg: rgba(0, 0, 0, 0.75);
                --panel-border: rgba(212, 175, 55, 0.3);
                --team-us: #3498db;
                --team-them: #e74c3c;
            }

            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Source Sans 3", sans-serif;
                background: var(--felt-dark);
                color: #f0f0f0;
                min-height: 100vh;
                overflow-x: hidden;
            }

            .table-surface {
                position: fixed;
                inset: 0;
                background:
                    radial-gradient(
                        ellipse 120% 100% at 50% 100%,
                        var(--felt-light) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse 120% 100% at 50% 0%,
                        var(--felt-light) 0%,
                        transparent 50%
                    ),
                    radial-gradient(
                        ellipse at center,
                        var(--felt-main) 0%,
                        var(--felt-dark) 100%
                    );
                z-index: 0;
            }

            .table-surface::before {
                content: "";
                position: absolute;
                inset: 0;
                background: url("data:image/svg+xml,%3Csvg viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
                opacity: 0.03;
                pointer-events: none;
            }

            .game-wrapper {
                position: relative;
                z-index: 1;
                max-width: 1000px;
                margin: 0 auto;
                padding: 0.75rem;
                min-height: 100vh;
                display: flex;
                flex-direction: column;
            }

            /* Header */
            .header {
                background: var(--panel-bg);
                backdrop-filter: blur(12px);
                border: 1px solid var(--panel-border);
                border-radius: 12px;
                padding: 0.75rem 1rem;
                margin-bottom: 0.75rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .title-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            h1 {
                font-family: "Playfair Display", serif;
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--gold);
                letter-spacing: 0.05em;
            }

            .btn {
                font-family: "Source Sans 3", sans-serif;
                font-size: 0.8rem;
                font-weight: 500;
                padding: 0.4rem 0.75rem;
                border: 1px solid var(--gold-dark);
                border-radius: 6px;
                background: linear-gradient(
                    135deg,
                    rgba(212, 175, 55, 0.2) 0%,
                    rgba(184, 134, 11, 0.1) 100%
                );
                color: var(--gold-light);
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .btn:hover {
                background: linear-gradient(
                    135deg,
                    rgba(212, 175, 55, 0.4) 0%,
                    rgba(184, 134, 11, 0.2) 100%
                );
                transform: translateY(-1px);
            }

            .btn-primary {
                background: linear-gradient(
                    135deg,
                    var(--gold) 0%,
                    var(--gold-dark) 100%
                );
                color: #000;
                border: none;
                font-weight: 600;
            }

            .btn-primary:hover {
                background: linear-gradient(
                    135deg,
                    var(--gold-light) 0%,
                    var(--gold) 100%
                );
            }

            select {
                font-family: "Source Sans 3", sans-serif;
                font-size: 0.8rem;
                padding: 0.4rem 0.5rem;
                border: 1px solid var(--gold-dark);
                border-radius: 6px;
                background: rgba(0, 0, 0, 0.5);
                color: var(--gold-light);
                cursor: pointer;
            }

            .score-section {
                display: flex;
                align-items: center;
                gap: 1.5rem;
            }

            .trump-display {
                text-align: center;
            }

            .trump-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: rgba(255, 255, 255, 0.6);
            }

            .trump-suit {
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--gold);
                line-height: 1;
            }

            .trump-suit.red {
                color: #e74c3c;
            }
            .trump-suit.black {
                color: #ecf0f1;
            }

            .scores {
                display: flex;
                gap: 1.25rem;
            }

            .score-box {
                text-align: center;
                min-width: 50px;
            }

            .score-box .label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: rgba(255, 255, 255, 0.6);
            }

            .score-box.us .label {
                color: var(--team-us);
            }
            .score-box.them .label {
                color: var(--team-them);
            }

            .score-box .value {
                font-family: "Playfair Display", serif;
                font-size: 1.5rem;
                font-weight: 700;
                color: var(--gold);
            }

            /* Game Table Layout */
            .game-table {
                flex: 1;
                display: grid;
                grid-template-columns: auto 1fr auto;
                grid-template-rows: auto 1fr auto;
                gap: 0.5rem;
                min-height: 0;
            }

            /* Player Zones */
            .player-zone {
                background: var(--panel-bg);
                backdrop-filter: blur(8px);
                border: 1px solid var(--panel-border);
                border-radius: 12px;
                padding: 0.5rem;
                display: flex;
                flex-direction: column;
                align-items: center;
                transition: all 0.3s ease;
            }

            .player-zone.active {
                border-color: var(--gold);
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            }

            .player-zone.team-us {
                border-left: 3px solid var(--team-us);
            }
            .player-zone.team-them {
                border-left: 3px solid var(--team-them);
            }

            /* Position zones */
            .zone-top {
                grid-column: 2;
                grid-row: 1;
            }
            .zone-left {
                grid-column: 1;
                grid-row: 2;
            }
            .zone-right {
                grid-column: 3;
                grid-row: 2;
            }
            .zone-bottom {
                grid-column: 2;
                grid-row: 3;
            }

            .zone-left,
            .zone-right {
                justify-content: center;
                min-width: 90px;
            }

            .player-info {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.25rem;
            }

            .player-name {
                font-family: "Playfair Display", serif;
                font-size: 0.9rem;
                font-weight: 600;
                color: var(--gold);
            }

            .player-badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.4rem;
                border-radius: 10px;
                font-weight: 600;
            }

            .badge-dealer {
                background: var(--gold);
                color: #000;
            }

            .badge-caller {
                background: #9b59b6;
                color: #fff;
            }

            .badge-alone {
                background: #e74c3c;
                color: #fff;
            }

            /* Cards */
            .cards-row {
                display: flex;
                justify-content: center;
                gap: 0.25rem;
            }

            .cards-row.vertical {
                flex-direction: column;
            }

            .card {
                width: 50px;
                height: 70px;
                border-radius: 6px;
                background: linear-gradient(145deg, #fff 0%, #f5f5f5 100%);
                border: 2px solid #ddd;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-weight: 700;
                box-shadow: var(--card-shadow);
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                user-select: none;
                position: relative;
                flex-shrink: 0;
            }

            @media (min-width: 640px) {
                .card {
                    width: 60px;
                    height: 84px;
                }
            }

            .card.red {
                color: #c0392b;
            }
            .card.black {
                color: #2c3e50;
            }

            .card-rank {
                font-size: 1.1rem;
                line-height: 1;
            }

            .card-suit {
                font-size: 0.9rem;
                margin-top: 1px;
            }

            @media (min-width: 640px) {
                .card-rank {
                    font-size: 1.3rem;
                }
                .card-suit {
                    font-size: 1.1rem;
                }
            }

            .card.playable {
                cursor: pointer;
                border-color: var(--gold);
            }

            .card.playable:hover {
                transform: translateY(-10px) scale(1.05);
                box-shadow: var(--card-hover-shadow);
                z-index: 10;
            }

            .card.face-down {
                background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
                border-color: var(--gold-dark);
            }

            .card.face-down::before {
                content: "";
                position: absolute;
                inset: 4px;
                border: 1px solid rgba(212, 175, 55, 0.3);
                border-radius: 3px;
                background: repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 3px,
                    rgba(212, 175, 55, 0.1) 3px,
                    rgba(212, 175, 55, 0.1) 6px
                );
            }

            .card.small {
                width: 35px;
                height: 49px;
            }

            .card.small .card-rank {
                font-size: 0.85rem;
            }
            .card.small .card-suit {
                font-size: 0.7rem;
            }

            /* Center Play Area */
            .center-area {
                grid-column: 2;
                grid-row: 2;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .trick-zone {
                position: relative;
                width: 180px;
                height: 180px;
                background: radial-gradient(
                    ellipse at center,
                    rgba(212, 175, 55, 0.08) 0%,
                    transparent 70%
                );
                border: 2px dashed rgba(212, 175, 55, 0.3);
                border-radius: 50%;
            }

            @media (min-width: 640px) {
                .trick-zone {
                    width: 220px;
                    height: 220px;
                }
            }

            .trick-card {
                position: absolute;
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .trick-card.visible {
                opacity: 1;
                visibility: visible;
            }

            .trick-card.winner {
                box-shadow:
                    0 0 20px rgba(212, 175, 55, 0.6),
                    var(--card-shadow);
            }

            /* Position trick cards */
            .trick-card.pos-top {
                top: 5px;
                left: 50%;
                transform: translateX(-50%);
            }
            .trick-card.pos-bottom {
                bottom: 5px;
                left: 50%;
                transform: translateX(-50%);
            }
            .trick-card.pos-left {
                left: 5px;
                top: 50%;
                transform: translateY(-50%);
            }
            .trick-card.pos-right {
                right: 5px;
                top: 50%;
                transform: translateY(-50%);
            }

            /* Kitty / Up Card */
            .kitty-area {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
            }

            .kitty-label {
                font-size: 0.7rem;
                color: rgba(255, 255, 255, 0.6);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .kitty-cards {
                position: relative;
                width: 50px;
                height: 70px;
            }

            @media (min-width: 640px) {
                .kitty-cards {
                    width: 60px;
                    height: 84px;
                }
            }

            .kitty-cards .card {
                position: absolute;
                top: 0;
                left: 0;
            }

            .kitty-cards .card:nth-child(2) {
                top: 2px;
                left: 2px;
            }
            .kitty-cards .card:nth-child(3) {
                top: 4px;
                left: 4px;
            }
            .kitty-cards .card.up-card {
                top: -5px;
                left: -5px;
            }

            /* Status */
            .status-bar {
                text-align: center;
                font-size: 0.85rem;
                color: rgba(255, 255, 255, 0.8);
                min-height: 1.5rem;
                margin-top: 0.25rem;
            }

            .status-bar .highlight {
                color: var(--gold);
                font-weight: 600;
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.4);
                z-index: 100;
                display: flex;
                justify-content: center;
                align-items: flex-start;
                padding: 1.5rem 1rem;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            .modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }

            .modal {
                background: linear-gradient(
                    145deg,
                    rgba(26, 77, 46, 0.98) 0%,
                    rgba(10, 31, 18, 0.98) 100%
                );
                border: 2px solid var(--gold);
                border-radius: 16px;
                padding: 1.5rem;
                max-width: 420px;
                width: 100%;
                text-align: center;
                transform: scale(0.9);
                transition: transform 0.3s ease;
            }

            .modal-overlay.visible .modal {
                transform: scale(1);
            }

            .modal h2 {
                font-family: "Playfair Display", serif;
                font-size: 1.4rem;
                color: var(--gold);
                margin-bottom: 0.75rem;
            }

            .modal-content {
                color: rgba(255, 255, 255, 0.9);
                margin-bottom: 1rem;
                line-height: 1.5;
                font-size: 0.95rem;
            }

            .modal-buttons {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .suit-btn {
                width: 50px;
                height: 50px;
                border-radius: 10px;
                font-size: 1.75rem;
                border: 2px solid transparent;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .suit-btn.hearts,
            .suit-btn.diamonds {
                background: linear-gradient(145deg, #e74c3c 0%, #c0392b 100%);
                color: #fff;
            }

            .suit-btn.spades,
            .suit-btn.clubs {
                background: linear-gradient(145deg, #34495e 0%, #2c3e50 100%);
                color: #fff;
            }

            .suit-btn:hover {
                transform: scale(1.1);
                border-color: var(--gold);
            }

            .up-card-display {
                display: flex;
                justify-content: center;
                margin: 1rem 0;
            }

            /* Animations */
            @keyframes cardEnter {
                0% {
                    opacity: 0;
                    transform: scale(0.5) translateY(-20px);
                }
                100% {
                    opacity: 1;
                    transform: scale(1) translateY(0);
                }
            }

            @keyframes cardExit {
                0% {
                    opacity: 1;
                    transform: scale(1);
                }
                100% {
                    opacity: 0;
                    transform: scale(0.3);
                }
            }

            .card-enter {
                animation: cardEnter 0.35s ease-out forwards;
            }

            .card-exit {
                animation: cardExit 0.4s ease-in forwards;
            }

            /* Thinking indicator */
            .thinking {
                display: inline-flex;
                gap: 3px;
                margin-left: 6px;
            }

            .thinking span {
                width: 5px;
                height: 5px;
                background: var(--gold);
                border-radius: 50%;
                animation: bounce 1.4s infinite ease-in-out both;
            }

            .thinking span:nth-child(1) {
                animation-delay: -0.32s;
            }
            .thinking span:nth-child(2) {
                animation-delay: -0.16s;
            }

            @keyframes bounce {
                0%,
                80%,
                100% {
                    transform: scale(0);
                }
                40% {
                    transform: scale(1);
                }
            }

            /* Rules */
            .rules-content {
                text-align: left;
                font-size: 0.85rem;
                max-height: 55vh;
                overflow-y: auto;
            }

            .rules-content h4 {
                color: var(--gold);
                margin: 0.75rem 0 0.35rem;
                font-size: 0.95rem;
            }

            .rules-content h4:first-child {
                margin-top: 0;
            }

            .rules-content p,
            .rules-content ul {
                margin-bottom: 0.35rem;
                color: rgba(255, 255, 255, 0.85);
            }

            .rules-content ul {
                padding-left: 1.25rem;
            }
            .rules-content li {
                margin-bottom: 0.2rem;
            }

            /* Trick counter */
            .trick-counter {
                font-size: 0.75rem;
                color: rgba(255, 255, 255, 0.6);
            }

            .trick-counter .us {
                color: var(--team-us);
            }
            .trick-counter .them {
                color: var(--team-them);
            }
        </style>
    </head>
    <body>
        <div class="table-surface"></div>

        <div class="game-wrapper">
            <header class="header">
                <div class="title-section">
                    <h1>Euchre</h1>
                    <button class="btn" id="rules-btn">Rules</button>
                    <select id="difficulty">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>

                <div class="score-section">
                    <div class="trump-display">
                        <div class="trump-label">Trump</div>
                        <div class="trump-suit" id="trump-indicator">—</div>
                    </div>
                    <div class="scores">
                        <div class="score-box us">
                            <div class="label">Us</div>
                            <div class="value" id="score-us">0</div>
                        </div>
                        <div class="score-box them">
                            <div class="label">Them</div>
                            <div class="value" id="score-them">0</div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="game-table">
                <!-- Partner (Top) -->
                <section class="player-zone zone-top team-us" id="zone-partner">
                    <div class="player-info">
                        <span class="player-name">Partner</span>
                        <span
                            class="player-badge badge-dealer"
                            id="badge-partner-dealer"
                            style="display: none"
                            >D</span
                        >
                        <span
                            class="player-badge badge-caller"
                            id="badge-partner-caller"
                            style="display: none"
                            >★</span
                        >
                    </div>
                    <div class="cards-row" id="hand-partner"></div>
                </section>

                <!-- Left Opponent -->
                <section class="player-zone zone-left team-them" id="zone-left">
                    <div class="player-info">
                        <span class="player-name">West</span>
                        <span
                            class="player-badge badge-dealer"
                            id="badge-left-dealer"
                            style="display: none"
                            >D</span
                        >
                        <span
                            class="player-badge badge-caller"
                            id="badge-left-caller"
                            style="display: none"
                            >★</span
                        >
                    </div>
                    <div class="cards-row vertical" id="hand-left"></div>
                </section>

                <!-- Center Area -->
                <div class="center-area">
                    <div class="kitty-area" id="kitty-area">
                        <div class="kitty-label">Up Card</div>
                        <div class="kitty-cards" id="kitty-cards"></div>
                    </div>

                    <div class="trick-zone" id="trick-zone">
                        <div
                            class="card trick-card pos-top"
                            id="played-partner"
                        ></div>
                        <div
                            class="card trick-card pos-left"
                            id="played-left"
                        ></div>
                        <div
                            class="card trick-card pos-right"
                            id="played-right"
                        ></div>
                        <div
                            class="card trick-card pos-bottom"
                            id="played-player"
                        ></div>
                    </div>

                    <div class="trick-counter">
                        Tricks: <span class="us" id="tricks-us">0</span> -
                        <span class="them" id="tricks-them">0</span>
                    </div>
                </div>

                <!-- Right Opponent -->
                <section
                    class="player-zone zone-right team-them"
                    id="zone-right"
                >
                    <div class="player-info">
                        <span class="player-name">East</span>
                        <span
                            class="player-badge badge-dealer"
                            id="badge-right-dealer"
                            style="display: none"
                            >D</span
                        >
                        <span
                            class="player-badge badge-caller"
                            id="badge-right-caller"
                            style="display: none"
                            >★</span
                        >
                    </div>
                    <div class="cards-row vertical" id="hand-right"></div>
                </section>

                <!-- Player (Bottom) -->
                <section
                    class="player-zone zone-bottom team-us"
                    id="zone-player"
                >
                    <div class="player-info">
                        <span class="player-name">You</span>
                        <span
                            class="player-badge badge-dealer"
                            id="badge-player-dealer"
                            style="display: none"
                            >D</span
                        >
                        <span
                            class="player-badge badge-caller"
                            id="badge-player-caller"
                            style="display: none"
                            >★</span
                        >
                    </div>
                    <div class="cards-row" id="hand-player"></div>
                </section>
            </main>

            <div class="status-bar" id="status"></div>
        </div>

        <!-- Modal -->
        <div class="modal-overlay" id="modal">
            <div class="modal">
                <h2 id="modal-title"></h2>
                <div class="modal-content" id="modal-content"></div>
                <div class="modal-buttons" id="modal-buttons"></div>
            </div>
        </div>

        <script>
            // ============================================
            // CONSTANTS
            // ============================================
            const SUITS = { S: "♠", H: "♥", D: "♦", C: "♣" };
            const SUIT_COLORS = { S: "black", H: "red", D: "red", C: "black" };
            const SAME_COLOR = { S: "C", C: "S", H: "D", D: "H" };
            const RANKS = ["9", "10", "J", "Q", "K", "A"];
            const RANK_ORDER = { 9: 0, 10: 1, J: 2, Q: 3, K: 4, A: 5 };
            const WINNING_SCORE = 10;

            // Player positions: 0=player, 1=left, 2=partner, 3=right
            const POSITIONS = ["player", "left", "partner", "right"];
            const TEAMS = {
                player: "us",
                partner: "us",
                left: "them",
                right: "them",
            };

            // ============================================
            // GAME STATE
            // ============================================
            const state = {
                deck: [],
                hands: { player: [], left: [], partner: [], right: [] },
                kitty: [],
                upCard: null,
                trump: null,
                trumpCaller: null,
                goingAlone: false,
                alonePlayer: null,
                scores: { us: 0, them: 0 },
                tricks: { us: 0, them: 0 },
                dealer: 0, // Index in POSITIONS
                currentPlayer: 0,
                leadPlayer: 0,
                playedCards: [], // { player, card }
                gamePhase: "idle",
                difficulty: "medium",
                trumpRound: 1, // 1 = must order up card suit, 2 = can call any other suit
            };

            // ============================================
            // DOM ELEMENTS
            // ============================================
            const els = {
                scoreUs: document.getElementById("score-us"),
                scoreThem: document.getElementById("score-them"),
                tricksUs: document.getElementById("tricks-us"),
                tricksThem: document.getElementById("tricks-them"),
                trumpIndicator: document.getElementById("trump-indicator"),
                status: document.getElementById("status"),
                kittyArea: document.getElementById("kitty-area"),
                kittyCards: document.getElementById("kitty-cards"),
                trickZone: document.getElementById("trick-zone"),
                modal: document.getElementById("modal"),
                modalTitle: document.getElementById("modal-title"),
                modalContent: document.getElementById("modal-content"),
                modalButtons: document.getElementById("modal-buttons"),
                hands: {
                    player: document.getElementById("hand-player"),
                    left: document.getElementById("hand-left"),
                    partner: document.getElementById("hand-partner"),
                    right: document.getElementById("hand-right"),
                },
                zones: {
                    player: document.getElementById("zone-player"),
                    left: document.getElementById("zone-left"),
                    partner: document.getElementById("zone-partner"),
                    right: document.getElementById("zone-right"),
                },
                played: {
                    player: document.getElementById("played-player"),
                    left: document.getElementById("played-left"),
                    partner: document.getElementById("played-partner"),
                    right: document.getElementById("played-right"),
                },
                badges: {
                    player: {
                        dealer: document.getElementById("badge-player-dealer"),
                        caller: document.getElementById("badge-player-caller"),
                    },
                    left: {
                        dealer: document.getElementById("badge-left-dealer"),
                        caller: document.getElementById("badge-left-caller"),
                    },
                    partner: {
                        dealer: document.getElementById("badge-partner-dealer"),
                        caller: document.getElementById("badge-partner-caller"),
                    },
                    right: {
                        dealer: document.getElementById("badge-right-dealer"),
                        caller: document.getElementById("badge-right-caller"),
                    },
                },
            };

            // ============================================
            // UTILITIES
            // ============================================
            function delay(ms) {
                return new Promise((resolve) => setTimeout(resolve, ms));
            }

            function createDeck() {
                const deck = [];
                for (const suit in SUITS) {
                    for (const rank of RANKS) {
                        deck.push({ rank, suit });
                    }
                }
                return deck;
            }

            function shuffleDeck(deck) {
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
                return deck;
            }

            function getEffectiveSuit(card) {
                if (!card || !state.trump) return card?.suit;
                if (
                    card.rank === "J" &&
                    card.suit === SAME_COLOR[state.trump]
                ) {
                    return state.trump;
                }
                return card.suit;
            }

            function getCardPower(card, leadSuit = null) {
                if (!card) return -1;
                const effSuit = getEffectiveSuit(card);
                const isTrump = effSuit === state.trump;

                if (isTrump) {
                    if (card.rank === "J" && card.suit === state.trump)
                        return 106; // Right bower
                    if (
                        card.rank === "J" &&
                        card.suit === SAME_COLOR[state.trump]
                    )
                        return 105; // Left bower
                    return 100 + RANK_ORDER[card.rank];
                }

                // If following lead suit
                if (leadSuit && effSuit === leadSuit) {
                    return 50 + RANK_ORDER[card.rank];
                }

                return RANK_ORDER[card.rank];
            }

            function cardToString(card) {
                return card ? `${card.rank}${SUITS[card.suit]}` : "?";
            }

            function getNextPlayer(current) {
                let next = (current + 1) % 4;
                // Skip partner if someone is going alone
                if (
                    state.goingAlone &&
                    POSITIONS[next] === getPartner(state.alonePlayer)
                ) {
                    next = (next + 1) % 4;
                }
                return next;
            }

            function getPartner(pos) {
                const partners = {
                    player: "partner",
                    partner: "player",
                    left: "right",
                    right: "left",
                };
                return partners[pos];
            }

            function isBot(pos) {
                return pos !== "player";
            }

            // ============================================
            // UI RENDERING
            // ============================================
            function createCardElement(card, small = false) {
                const el = document.createElement("div");
                if (card) {
                    el.className = `card ${SUIT_COLORS[card.suit]}${small ? " small" : ""}`;
                    el.innerHTML = `<span class="card-rank">${card.rank}</span><span class="card-suit">${SUITS[card.suit]}</span>`;
                    el.dataset.rank = card.rank;
                    el.dataset.suit = card.suit;
                } else {
                    el.className = `card face-down${small ? " small" : ""}`;
                }
                return el;
            }

            function renderHands() {
                POSITIONS.forEach((pos) => {
                    els.hands[pos].innerHTML = "";
                    const hand = state.hands[pos];

                    hand.forEach((card, i) => {
                        const showCard = pos === "player";
                        const cardEl = createCardElement(
                            showCard ? card : null,
                        );

                        if (pos === "player") {
                            cardEl.id = `card-${i}`;
                        }

                        els.hands[pos].appendChild(cardEl);
                    });
                });

                updatePlayableCards();
                updateBadges();
                updateActiveZone();
            }

            function renderKitty() {
                els.kittyCards.innerHTML = "";

                // Show face-down kitty cards
                for (let i = 0; i < Math.min(3, state.kitty.length); i++) {
                    els.kittyCards.appendChild(createCardElement(null));
                }

                // Show up card
                if (state.upCard) {
                    const upEl = createCardElement(state.upCard);
                    upEl.classList.add("up-card");
                    els.kittyCards.appendChild(upEl);
                }
            }

            function updatePlayableCards() {
                document.querySelectorAll(".card.playable").forEach((c) => {
                    c.classList.remove("playable");
                    c.onclick = null;
                });

                const currentPos = POSITIONS[state.currentPlayer];
                if (currentPos !== "player" || state.gamePhase !== "playing")
                    return;

                const playable = getPlayableCards("player");
                playable.forEach((i) => {
                    const el = document.getElementById(`card-${i}`);
                    if (el) {
                        el.classList.add("playable");
                        el.onclick = () => playerPlaysCard(i);
                    }
                });
            }

            function updateBadges() {
                POSITIONS.forEach((pos, i) => {
                    els.badges[pos].dealer.style.display =
                        i === state.dealer ? "" : "none";
                    els.badges[pos].caller.style.display =
                        pos === state.trumpCaller ? "" : "none";
                });
            }

            function updateActiveZone() {
                POSITIONS.forEach((pos, i) => {
                    els.zones[pos].classList.toggle(
                        "active",
                        i === state.currentPlayer &&
                            state.gamePhase === "playing",
                    );
                });
            }

            function updateScores() {
                els.scoreUs.textContent = state.scores.us;
                els.scoreThem.textContent = state.scores.them;
                els.tricksUs.textContent = state.tricks.us;
                els.tricksThem.textContent = state.tricks.them;
            }

            function updateTrump() {
                if (state.trump) {
                    els.trumpIndicator.textContent = SUITS[state.trump];
                    els.trumpIndicator.className = `trump-suit ${SUIT_COLORS[state.trump]}`;
                } else {
                    els.trumpIndicator.textContent = "—";
                    els.trumpIndicator.className = "trump-suit";
                }
            }

            function setStatus(text, thinking = false) {
                els.status.innerHTML =
                    text +
                    (thinking
                        ? '<span class="thinking"><span></span><span></span><span></span></span>'
                        : "");
            }

            function clearPlayedCards() {
                POSITIONS.forEach((pos) => {
                    els.played[pos].className =
                        "card trick-card pos-" +
                        (pos === "player"
                            ? "bottom"
                            : pos === "partner"
                              ? "top"
                              : pos);
                    els.played[pos].innerHTML = "";
                });
            }

            // ============================================
            // MODAL
            // ============================================
            function showModal(title, content, buttons) {
                els.modalTitle.textContent = title;
                els.modalContent.innerHTML = content;
                els.modalButtons.innerHTML = "";

                buttons.forEach((btn) => {
                    const el = document.createElement("button");
                    if (btn.suit) {
                        el.className = `suit-btn ${btn.suit}`;
                        el.innerHTML = btn.text;
                    } else {
                        el.className = btn.class || "btn btn-primary";
                        el.textContent = btn.text;
                    }
                    el.onclick = () => {
                        hideModal();
                        btn.action();
                    };
                    els.modalButtons.appendChild(el);
                });

                els.modal.classList.add("visible");
            }

            function hideModal() {
                els.modal.classList.remove("visible");
            }

            function showRules() {
                showModal(
                    "Euchre Rules",
                    `
            <div class="rules-content">
                <h4>Objective</h4>
                <p>Be the first team to score ${WINNING_SCORE} points.</p>

                <h4>Teams</h4>
                <p>You and your partner (across) vs. the two opponents.</p>

                <h4>Card Rankings (Trump)</h4>
                <ul>
                    <li><strong>Right Bower:</strong> Jack of trump (highest)</li>
                    <li><strong>Left Bower:</strong> Jack of same color</li>
                    <li>A, K, Q, 10, 9 of trump</li>
                </ul>

                <h4>Dealing</h4>
                <p>Each player gets 5 cards. One card is turned up to propose trump.</p>

                <h4>Calling Trump</h4>
                <p><strong>Round 1:</strong> Players can order up the turned card's suit or pass.</p>
                <p><strong>Round 2:</strong> Players can call any other suit or pass. Dealer must call if all pass.</p>
                <p>You may "go alone" for bonus points (partner sits out).</p>

                <h4>Playing</h4>
                <p>Follow suit if possible. Highest trump wins, or highest of led suit.</p>

                <h4>Scoring</h4>
                <ul>
                    <li>3-4 tricks: 1 point</li>
                    <li>5 tricks (march): 2 points</li>
                    <li>Alone march: 4 points</li>
                    <li>Euchred (opponents take 3+): Opponents get 2 points</li>
                </ul>
            </div>
        `,
                    [{ text: "Got it!", action: () => {} }],
                );
            }

            // ============================================
            // CARD LOGIC
            // ============================================
            function getPlayableCards(pos) {
                const hand = state.hands[pos];
                if (state.playedCards.length === 0) {
                    // Leading - can play any card
                    return hand.map((_, i) => i);
                }

                const leadCard = state.playedCards[0].card;
                const leadSuit = getEffectiveSuit(leadCard);

                // Find cards that follow suit
                const following = [];
                hand.forEach((card, i) => {
                    if (getEffectiveSuit(card) === leadSuit) {
                        following.push(i);
                    }
                });

                return following.length > 0 ? following : hand.map((_, i) => i);
            }

            // ============================================
            // BOT AI
            // ============================================
            function evaluateHandForTrump(pos, suit) {
                const hand = state.hands[pos];
                let strength = 0;
                const leftBowerSuit = SAME_COLOR[suit];

                hand.forEach((card) => {
                    if (card.suit === suit) {
                        if (card.rank === "J") strength += 12;
                        else if (card.rank === "A") strength += 7;
                        else if (card.rank === "K") strength += 5;
                        else if (card.rank === "Q") strength += 3;
                        else strength += 1;
                    } else if (
                        card.suit === leftBowerSuit &&
                        card.rank === "J"
                    ) {
                        strength += 10;
                    } else if (card.rank === "A") {
                        strength += 3;
                    }
                });

                // Count trump
                const trumpCount = hand.filter(
                    (c) =>
                        c.suit === suit ||
                        (c.suit === leftBowerSuit && c.rank === "J"),
                ).length;

                if (trumpCount >= 3) strength += 4;
                if (trumpCount >= 4) strength += 5;

                return strength;
            }

            function botDecideTrump(pos, round) {
                const upCardSuit = state.upCard.suit;

                if (round === 1) {
                    const strength = evaluateHandForTrump(pos, upCardSuit);
                    let threshold = pos === POSITIONS[state.dealer] ? 14 : 16;

                    if (state.difficulty === "easy") threshold -= 4;
                    else if (state.difficulty === "hard") threshold += 2;

                    if (strength >= threshold) {
                        return {
                            call: true,
                            suit: upCardSuit,
                            alone: strength >= 26,
                        };
                    }
                    return { call: false };
                } else {
                    // Round 2 - can call any suit except up card suit
                    let bestSuit = null;
                    let bestStrength = 0;

                    for (const suit in SUITS) {
                        if (suit === upCardSuit) continue;
                        const strength = evaluateHandForTrump(pos, suit);
                        if (strength > bestStrength) {
                            bestStrength = strength;
                            bestSuit = suit;
                        }
                    }

                    let threshold = pos === POSITIONS[state.dealer] ? 0 : 14; // Dealer must call
                    if (state.difficulty === "easy") threshold -= 3;
                    else if (state.difficulty === "hard") threshold += 2;

                    if (
                        bestStrength >= threshold ||
                        pos === POSITIONS[state.dealer]
                    ) {
                        return {
                            call: true,
                            suit: bestSuit,
                            alone: bestStrength >= 26,
                        };
                    }
                    return { call: false };
                }
            }

            function botSelectCard(pos) {
                const hand = state.hands[pos];
                const playable = getPlayableCards(pos);

                if (playable.length === 1) return playable[0];

                const isLeading = state.playedCards.length === 0;
                const partnerPos = getPartner(pos);
                const partnerPlayed = state.playedCards.find(
                    (p) => p.player === partnerPos,
                );

                // Easy mode: random sometimes
                if (state.difficulty === "easy" && Math.random() < 0.2) {
                    return playable[
                        Math.floor(Math.random() * playable.length)
                    ];
                }

                if (isLeading) {
                    // Leading strategy
                    const scored = playable.map((i) => {
                        const card = hand[i];
                        let score = getCardPower(card);
                        const isTrump = getEffectiveSuit(card) === state.trump;

                        // Lead with off-suit aces
                        if (!isTrump && card.rank === "A") score += 20;
                        // Save trump for later
                        if (isTrump) score -= 10;

                        return { i, score };
                    });

                    scored.sort((a, b) => b.score - a.score);
                    return scored[0].i;
                } else {
                    // Following strategy
                    const leadCard = state.playedCards[0].card;
                    const leadSuit = getEffectiveSuit(leadCard);

                    // Determine current winning card
                    let winningPlay = state.playedCards[0];
                    state.playedCards.forEach((p) => {
                        if (
                            getCardPower(p.card, leadSuit) >
                            getCardPower(winningPlay.card, leadSuit)
                        ) {
                            winningPlay = p;
                        }
                    });

                    const partnerWinning =
                        TEAMS[winningPlay.player] === TEAMS[pos];

                    const scored = playable.map((i) => {
                        const card = hand[i];
                        const power = getCardPower(card, leadSuit);
                        const canWin =
                            power > getCardPower(winningPlay.card, leadSuit);
                        let score = 0;

                        if (partnerWinning) {
                            // Partner is winning - play low
                            score = -power;
                        } else if (canWin) {
                            // Can win - play lowest winning card
                            score = 100 - power;
                        } else {
                            // Can't win - dump lowest
                            score = -power;
                        }

                        return { i, score };
                    });

                    scored.sort((a, b) => b.score - a.score);
                    return scored[0].i;
                }
            }

            // ============================================
            // GAME FLOW
            // ============================================
            async function startGame() {
                state.scores = { us: 0, them: 0 };
                state.dealer = Math.floor(Math.random() * 4);
                updateScores();
                await startHand();
            }

            async function startHand() {
                // Reset hand state
                state.trump = null;
                state.trumpCaller = null;
                state.goingAlone = false;
                state.alonePlayer = null;
                state.tricks = { us: 0, them: 0 };
                state.playedCards = [];
                state.trumpRound = 1;
                state.dealer = (state.dealer + 1) % 4;

                updateScores();
                updateTrump();
                clearPlayedCards();

                // Create and shuffle deck
                state.deck = shuffleDeck(createDeck());

                // Deal 5 cards to each player
                state.hands = { player: [], left: [], partner: [], right: [] };
                for (let round = 0; round < 5; round++) {
                    POSITIONS.forEach((pos) => {
                        state.hands[pos].push(state.deck.pop());
                    });
                }

                // Turn up card, rest is kitty
                state.upCard = state.deck.pop();
                state.kitty = [...state.deck];
                state.deck = [];

                renderHands();
                renderKitty();
                els.kittyArea.style.display = "";

                await delay(500);

                // Start trump selection
                await trumpSelection();
            }

            async function trumpSelection() {
                state.gamePhase = "trumpSelect";
                state.currentPlayer = getNextPlayer(state.dealer);

                await trumpRound1();
            }

            async function trumpRound1() {
                state.trumpRound = 1;
                let current = getNextPlayer(state.dealer);

                for (let i = 0; i < 4; i++) {
                    const pos = POSITIONS[current];

                    if (pos === "player") {
                        // Player's turn
                        const upCardHtml = `<div class="up-card-display">${createCardElement(state.upCard).outerHTML}</div>`;
                        showModal(
                            "Order Up?",
                            `<p>Up card: ${SUITS[state.upCard.suit]}</p>${upCardHtml}<p>Order the dealer to pick it up?</p>`,
                            [
                                {
                                    text: "Order Up",
                                    class: "btn btn-primary",
                                    action: () =>
                                        playerCallsTrump(
                                            state.upCard.suit,
                                            false,
                                        ),
                                },
                                {
                                    text: "Go Alone!",
                                    class: "btn",
                                    action: () =>
                                        playerCallsTrump(
                                            state.upCard.suit,
                                            true,
                                        ),
                                },
                                {
                                    text: "Pass",
                                    class: "btn",
                                    action: () => playerPasses(1),
                                },
                            ],
                        );
                        return; // Wait for player input
                    } else {
                        // Bot's turn
                        setStatus(
                            `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} is thinking`,
                            true,
                        );
                        await delay(800 + Math.random() * 400);

                        const decision = botDecideTrump(pos, 1);
                        if (decision.call) {
                            await callTrump(pos, decision.suit, decision.alone);
                            return;
                        }

                        setStatus(
                            `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} passes`,
                        );
                        await delay(400);
                    }

                    current = getNextPlayer(current);
                }

                // Everyone passed round 1 - go to round 2
                await trumpRound2();
            }

            async function trumpRound2() {
                state.trumpRound = 2;
                let current = getNextPlayer(state.dealer);

                // Turn down the up card
                state.kitty.push(state.upCard);
                state.upCard = null;
                renderKitty();

                for (let i = 0; i < 4; i++) {
                    const pos = POSITIONS[current];
                    const isDealer = current === state.dealer;

                    if (pos === "player") {
                        const suitButtons = Object.entries(SUITS)
                            .filter(
                                ([s]) =>
                                    s !==
                                    state.kitty[state.kitty.length - 1].suit,
                            ) // Can't call turned down suit
                            .map(([s, symbol]) => ({
                                text: symbol,
                                suit:
                                    s === "H"
                                        ? "hearts"
                                        : s === "D"
                                          ? "diamonds"
                                          : s === "S"
                                            ? "spades"
                                            : "clubs",
                                action: () => playerCallsTrump(s, false),
                            }));

                        const buttons = [...suitButtons];
                        if (!isDealer) {
                            buttons.push({
                                text: "Pass",
                                class: "btn",
                                action: () => playerPasses(2),
                            });
                        }

                        showModal(
                            isDealer ? "You Must Call" : "Call Trump?",
                            `<p>${isDealer ? "Everyone passed. You must call trump." : "Name the trump suit or pass."}</p>`,
                            buttons,
                        );
                        return;
                    } else {
                        setStatus(
                            `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} is thinking`,
                            true,
                        );
                        await delay(800 + Math.random() * 400);

                        const decision = botDecideTrump(pos, 2);
                        if (decision.call || isDealer) {
                            await callTrump(pos, decision.suit, decision.alone);
                            return;
                        }

                        setStatus(
                            `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} passes`,
                        );
                        await delay(400);
                    }

                    current = getNextPlayer(current);
                }
            }

            function playerCallsTrump(suit, alone) {
                callTrump("player", suit, alone);
            }

            function playerPasses(round) {
                if (round === 1) {
                    continueRound1AfterPlayer();
                } else {
                    continueRound2AfterPlayer();
                }
            }

            async function continueRound1AfterPlayer() {
                let current = getNextPlayer(POSITIONS.indexOf("player"));

                while (current !== getNextPlayer(state.dealer)) {
                    const pos = POSITIONS[current];

                    setStatus(
                        `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} is thinking`,
                        true,
                    );
                    await delay(800 + Math.random() * 400);

                    const decision = botDecideTrump(pos, 1);
                    if (decision.call) {
                        await callTrump(pos, decision.suit, decision.alone);
                        return;
                    }

                    setStatus(
                        `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} passes`,
                    );
                    await delay(400);

                    current = getNextPlayer(current);
                }

                await trumpRound2();
            }

            async function continueRound2AfterPlayer() {
                let current = getNextPlayer(POSITIONS.indexOf("player"));

                while (true) {
                    const pos = POSITIONS[current];
                    const isDealer = current === state.dealer;

                    setStatus(
                        `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} is thinking`,
                        true,
                    );
                    await delay(800 + Math.random() * 400);

                    const decision = botDecideTrump(pos, 2);
                    if (decision.call || isDealer) {
                        await callTrump(pos, decision.suit, decision.alone);
                        return;
                    }

                    setStatus(
                        `${pos === "left" ? "West" : pos === "right" ? "East" : "Partner"} passes`,
                    );
                    await delay(400);

                    current = getNextPlayer(current);
                }
            }

            async function callTrump(pos, suit, alone) {
                state.trump = suit;
                state.trumpCaller = pos;
                state.goingAlone = alone;
                state.alonePlayer = alone ? pos : null;

                updateTrump();
                updateBadges();

                // If round 1, dealer picks up the up card
                if (state.trumpRound === 1 && state.upCard) {
                    const dealerPos = POSITIONS[state.dealer];
                    state.hands[dealerPos].push(state.upCard);
                    state.upCard = null;

                    // Bot dealer discards
                    if (dealerPos !== "player") {
                        await delay(500);
                        // Discard weakest card
                        let weakest = 0;
                        let weakestPower = Infinity;
                        state.hands[dealerPos].forEach((card, i) => {
                            const power = getCardPower(card);
                            if (power < weakestPower) {
                                weakestPower = power;
                                weakest = i;
                            }
                        });
                        state.kitty.push(
                            state.hands[dealerPos].splice(weakest, 1)[0],
                        );
                    } else {
                        // Player discards
                        renderHands();
                        await playerDiscard();
                        return;
                    }
                }

                els.kittyArea.style.display = "none";
                renderHands();

                const callerName =
                    pos === "player"
                        ? "You"
                        : pos === "partner"
                          ? "Partner"
                          : pos === "left"
                            ? "West"
                            : "East";
                const aloneText = alone ? " and going alone!" : "";

                showModal(
                    "Trump Called",
                    `<p>${callerName} called <span style="font-size:1.5rem">${SUITS[suit]}</span> as trump${aloneText}!</p>`,
                    [
                        {
                            text: "Start Playing",
                            class: "btn btn-primary",
                            action: startPlaying,
                        },
                    ],
                );
            }

            async function playerDiscard() {
                showModal(
                    "Discard a Card",
                    "<p>You picked up the up card. Click a card in your hand to discard.</p>",
                    [],
                );

                // Make all cards clickable for discard
                state.hands.player.forEach((card, i) => {
                    const el = document.getElementById(`card-${i}`);
                    if (el) {
                        el.classList.add("playable");
                        el.onclick = () => {
                            state.kitty.push(
                                state.hands.player.splice(i, 1)[0],
                            );
                            hideModal();
                            els.kittyArea.style.display = "none";
                            renderHands();

                            const callerName =
                                state.trumpCaller === "player"
                                    ? "You"
                                    : "Partner";
                            showModal(
                                "Trump Called",
                                `<p>${callerName} called <span style="font-size:1.5rem">${SUITS[state.trump]}</span> as trump!</p>`,
                                [
                                    {
                                        text: "Start Playing",
                                        class: "btn btn-primary",
                                        action: startPlaying,
                                    },
                                ],
                            );
                        };
                    }
                });
            }

            function startPlaying() {
                state.gamePhase = "playing";
                state.currentPlayer = getNextPlayer(state.dealer);
                state.leadPlayer = state.currentPlayer;

                updateActiveZone();
                renderHands();

                if (POSITIONS[state.currentPlayer] === "player") {
                    setStatus("Your lead");
                } else {
                    botTurn();
                }
            }

            async function playerPlaysCard(index) {
                if (
                    POSITIONS[state.currentPlayer] !== "player" ||
                    state.gamePhase !== "playing"
                )
                    return;

                const card = state.hands.player.splice(index, 1)[0];
                state.playedCards.push({ player: "player", card });

                // Show played card
                els.played.player.innerHTML = createCardElement(card).innerHTML;
                els.played.player.className = `card trick-card pos-bottom visible card-enter ${SUIT_COLORS[card.suit]}`;

                renderHands();

                if (state.playedCards.length === (state.goingAlone ? 3 : 4)) {
                    await delay(400);
                    evaluateTrick();
                } else {
                    state.currentPlayer = getNextPlayer(state.currentPlayer);
                    updateActiveZone();
                    await delay(300);
                    botTurn();
                }
            }

            async function botTurn() {
                const pos = POSITIONS[state.currentPlayer];
                const name =
                    pos === "partner"
                        ? "Partner"
                        : pos === "left"
                          ? "West"
                          : "East";

                setStatus(`${name} is thinking`, true);
                await delay(600 + Math.random() * 400);

                const cardIndex = botSelectCard(pos);
                const card = state.hands[pos].splice(cardIndex, 1)[0];
                state.playedCards.push({ player: pos, card });

                // Show played card
                const posClass = pos === "partner" ? "top" : pos;
                els.played[pos].innerHTML = createCardElement(card).innerHTML;
                els.played[pos].className =
                    `card trick-card pos-${posClass} visible card-enter ${SUIT_COLORS[card.suit]}`;

                renderHands();

                if (state.playedCards.length === (state.goingAlone ? 3 : 4)) {
                    await delay(500);
                    evaluateTrick();
                } else {
                    state.currentPlayer = getNextPlayer(state.currentPlayer);
                    updateActiveZone();

                    if (POSITIONS[state.currentPlayer] === "player") {
                        setStatus("Your turn");
                        renderHands();
                    } else {
                        await delay(200);
                        botTurn();
                    }
                }
            }

            async function evaluateTrick() {
                state.gamePhase = "trickEval";

                const leadCard = state.playedCards[0].card;
                const leadSuit = getEffectiveSuit(leadCard);

                let winner = state.playedCards[0];
                state.playedCards.forEach((p) => {
                    if (
                        getCardPower(p.card, leadSuit) >
                        getCardPower(winner.card, leadSuit)
                    ) {
                        winner = p;
                    }
                });

                const winningTeam = TEAMS[winner.player];
                state.tricks[winningTeam]++;
                updateScores();

                // Highlight winner
                els.played[winner.player].classList.add("winner");

                const winnerName =
                    winner.player === "player"
                        ? "You"
                        : winner.player === "partner"
                          ? "Partner"
                          : winner.player === "left"
                            ? "West"
                            : "East";
                setStatus(
                    `<span class="highlight">${winnerName}</span> won the trick!`,
                );

                await delay(1200);

                // Clear cards
                POSITIONS.forEach((pos) => {
                    els.played[pos].classList.add("card-exit");
                });

                await delay(400);
                clearPlayedCards();

                state.playedCards = [];

                // Check if hand is over
                if (state.tricks.us + state.tricks.them === 5) {
                    await endHand();
                } else {
                    state.gamePhase = "playing";
                    state.currentPlayer = POSITIONS.indexOf(winner.player);
                    state.leadPlayer = state.currentPlayer;
                    updateActiveZone();

                    if (POSITIONS[state.currentPlayer] === "player") {
                        setStatus("Your lead");
                        renderHands();
                    } else {
                        botTurn();
                    }
                }
            }

            async function endHand() {
                state.gamePhase = "handEnd";

                const callerTeam = TEAMS[state.trumpCaller];
                const callerTricks = state.tricks[callerTeam];
                const defenderTricks =
                    state.tricks[callerTeam === "us" ? "them" : "us"];

                let points = 0;
                let scoringTeam = callerTeam;
                let message = "";

                if (callerTricks >= 3) {
                    // Makers win
                    if (callerTricks === 5) {
                        // March
                        points = state.goingAlone ? 4 : 2;
                        message = state.goingAlone ? "Alone march!" : "March!";
                    } else {
                        points = 1;
                        message = `${callerTricks} tricks.`;
                    }
                } else {
                    // Euchred!
                    points = 2;
                    scoringTeam = callerTeam === "us" ? "them" : "us";
                    message = "Euchred!";
                }

                state.scores[scoringTeam] += points;
                updateScores();

                const teamName =
                    scoringTeam === "us" ? "Your team" : "Opponents";

                if (
                    state.scores.us >= WINNING_SCORE ||
                    state.scores.them >= WINNING_SCORE
                ) {
                    const gameWinner =
                        state.scores.us >= state.scores.them
                            ? "Your team"
                            : "Opponents";
                    showModal(
                        "Game Over!",
                        `<p><strong>${gameWinner}</strong> won!</p>
                <p>Final: Us ${state.scores.us} - ${state.scores.them} Them</p>`,
                        [
                            {
                                text: "Play Again",
                                class: "btn btn-primary",
                                action: startGame,
                            },
                        ],
                    );
                } else {
                    showModal(
                        "Hand Complete",
                        `<p>${message}</p>
                <p><strong>${teamName}</strong> score ${points} point${points > 1 ? "s" : ""}.</p>
                <p>Score: Us ${state.scores.us} - ${state.scores.them} Them</p>`,
                        [
                            {
                                text: "Next Hand",
                                class: "btn btn-primary",
                                action: startHand,
                            },
                        ],
                    );
                }
            }

            // ============================================
            // EVENT LISTENERS
            // ============================================
            document
                .getElementById("rules-btn")
                .addEventListener("click", showRules);
            document
                .getElementById("difficulty")
                .addEventListener("change", (e) => {
                    state.difficulty = e.target.value;
                });

            // ============================================
            // INIT
            // ============================================
            showModal(
                "Euchre",
                `<p>Classic 4-player card game.</p>
        <p>You and your partner vs. two opponents.</p>
        <p>First to ${WINNING_SCORE} points wins!</p>`,
                [
                    {
                        text: "Start Game",
                        class: "btn btn-primary",
                        action: startGame,
                    },
                ],
            );
        </script>
    </body>
</html>
