<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Static Chatbot Interface</title>
        <!-- explicit favicon reference -->
        <link rel="icon" href="/chat/favicon.ico" />

        <style>
            :root {
                --sidebar-bg: #202123;
                --main-bg: #343541;
                --header-bg: #202123;
                --input-bg: #40414f;
                --bot-bg: #444654;
                --user-bg: #11a37f;
                --text-color: #d1d5db;
                --sidebar-text: #ffffff;
                --placeholder: #8b8a8f;
            }
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                display: flex;
                height: 100vh;
                font-family: ui-sans-serif, system-ui, sans-serif;
                color: var(--text-color);
                background: var(--main-bg);
            }
            .sidebar {
                width: 260px;
                background: var(--sidebar-bg);
                display: flex;
                flex-direction: column;
            }
            .sidebar-header {
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 1rem;
                border-bottom: 1px solid #3e3f41;
            }
            .sidebar-header .title {
                font-size: 1rem;
                color: var(--sidebar-text);
                font-weight: bold;
            }
            .sidebar-header button {
                background: transparent;
                border: none;
                color: var(--sidebar-text);
                font-size: 1.5rem;
                cursor: pointer;
            }
            .chat-history {
                flex: 1;
                overflow-y: auto;
                padding: 0.5rem;
            }
            .history-item {
                padding: 0.5rem;
                margin: 0.25rem 0;
                border-radius: 4px;
                cursor: pointer;
                color: var(--sidebar-text);
                background: #2f2f31;
            }
            .history-item.active {
                background: #3e3f41;
            }
            .history-item:hover {
                background: #3e3f41;
            }
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .main-header {
                height: 60px;
                background: var(--header-bg);
                display: flex;
                align-items: center;
                padding: 0 1rem;
                font-size: 1rem;
                color: var(--sidebar-text);
                border-bottom: 1px solid #3e3f41;
            }
            .main-body {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                position: relative;
            }
            .welcome {
                text-align: center;
                margin-top: 2rem;
                color: var(--placeholder);
            }
            .chat-item {
                max-width: 70%;
                padding: 0.6rem 0.8rem;
                margin: 0.5rem 0;
                border-radius: 15px;
                line-height: 1.4;
                opacity: 0;
                transform: translateY(10px);
                transition:
                    opacity 0.3s ease,
                    transform 0.3s ease;
                position: relative;
            }
            .chat-item.visible {
                opacity: 1;
                transform: translateY(0);
            }
            .chat-item.bot {
                background: var(--bot-bg);
                color: #fff;
                align-self: flex-start;
            }
            .chat-item.user {
                background: var(--user-bg);
                color: #fff;
                align-self: flex-end;
            }
            .chat-item .regenerate {
                position: absolute;
                top: 4px;
                right: 8px;
                background: transparent;
                border: none;
                color: var(--placeholder);
                font-size: 0.9rem;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.2s;
            }
            .chat-item.bot:hover .regenerate {
                opacity: 1;
            }
            .input-container {
                padding: 0.5rem;
                border-top: 1px solid #3e3f41;
                background: var(--input-bg);
            }
            .input-container form {
                display: flex;
            }
            .input-container input[type="text"] {
                flex: 1;
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
                border: none;
                border-radius: 4px;
                background: #55555d;
                color: var(--text-color);
            }
            .input-container input[type="text"]::placeholder {
                color: var(--placeholder);
            }
            .input-container button {
                margin-left: 0.5rem;
                padding: 0 1rem;
                font-size: 0.95rem;
                border: none;
                border-radius: 4px;
                background: #10a37f;
                color: #fff;
                cursor: pointer;
            }
            .input-container button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            #typing-indicator {
                display: flex;
                align-items: center;
                height: 24px;
                margin: 0.5rem;
            }
            .dot {
                width: 8px;
                height: 8px;
                margin: 0 2px;
                background: var(--placeholder);
                border-radius: 50%;
                opacity: 0.4;
                animation: blink 1s infinite;
            }
            .dot:nth-child(2) {
                animation-delay: 0.2s;
            }
            .dot:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes blink {
                0%,
                80%,
                100% {
                    opacity: 0.4;
                }
                40% {
                    opacity: 1;
                }
            }
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: var(--main-bg);
            }
            ::-webkit-scrollbar-thumb {
                background: #5a5a60;
                border-radius: 4px;
            }
        </style>
    </head>

    <body>
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="title">Chatbot</span>
                <button id="new-chat" title="New Chat">＋</button>
            </div>
            <div class="chat-history" id="chat-history-sidebar"></div>
        </div>
        <div class="main">
            <div class="main-header">Static Chatbot</div>
            <div class="main-body" id="main-body"></div>
            <div class="input-container">
                <form id="chat-form">
                    <input
                        type="text"
                        id="user-input"
                        placeholder="Loading model..."
                        disabled
                        autocomplete="off"
                    />
                    <button type="submit" id="send-btn" disabled>Send</button>
                </form>
            </div>
        </div>

        <script type="module">
            import {
                pipeline,
                env,
            } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js";

            // allow same-origin model loading
            env.allowRemoteModels = true;

            // DOM elements
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");
            const chatForm = document.getElementById("chat-form");
            const mainBody = document.getElementById("main-body");
            const historyEl = document.getElementById("chat-history-sidebar");
            const newChatBtn = document.getElementById("new-chat");

            // chat state
            let chats = [];
            let currentChatIndex = -1;
            let generator;

            // persist chats
            const saveChats = () =>
                localStorage.setItem("chats", JSON.stringify(chats));
            const loadChats = () => {
                const s = localStorage.getItem("chats");
                if (s) chats = JSON.parse(s);
                if (!chats.length) newChat();
            };

            // UI functions
            function newChat() {
                chats.push([]);
                currentChatIndex = chats.length - 1;
                renderHistory();
                renderChat();
            }
            function renderHistory() {
                historyEl.innerHTML = "";
                chats.forEach((_, idx) => {
                    const item = document.createElement("div");
                    item.className =
                        "history-item" +
                        (idx === currentChatIndex ? " active" : "");
                    item.textContent = "Chat " + (idx + 1);
                    item.onclick = () => {
                        currentChatIndex = idx;
                        renderHistory();
                        renderChat();
                    };
                    historyEl.appendChild(item);
                });
            }
            function renderChat() {
                mainBody.innerHTML = "";
                const session = chats[currentChatIndex];
                if (!session.length) {
                    const w = document.createElement("div");
                    w.className = "welcome";
                    w.textContent = "Welcome! Start typing to chat.";
                    mainBody.appendChild(w);
                } else {
                    session.forEach((m, i) => {
                        const b = document.createElement("div");
                        b.className = "chat-item " + m.sender;
                        b.textContent = m.text;
                        if (m.sender === "bot") {
                            const r = document.createElement("button");
                            r.className = "regenerate";
                            r.textContent = "↻";
                            r.onclick = () => regenerate(i);
                            b.appendChild(r);
                        }
                        mainBody.appendChild(b);
                        requestAnimationFrame(() => b.classList.add("visible"));
                    });
                }
                mainBody.scrollTop = mainBody.scrollHeight;
                saveChats();
            }
            function addMessage(text, sender) {
                chats[currentChatIndex].push({ text, sender });
                renderChat();
            }
            function showTyping() {
                const ind = document.createElement("div");
                ind.id = "typing-indicator";
                ["", "", ""].forEach(() => {
                    const d = document.createElement("div");
                    d.className = "dot";
                    ind.appendChild(d);
                });
                mainBody.appendChild(ind);
                mainBody.scrollTop = mainBody.scrollHeight;
            }
            function hideTyping() {
                const e = document.getElementById("typing-indicator");
                if (e) e.remove();
            }
            async function generateReply(text) {
                if (!generator) return "Model not ready";
                try {
                    const out = await generator(text, { max_new_tokens: 50 });
                    return out[0]?.generated_text.trim();
                } catch (e) {
                    console.error(e);
                    return "Error generating response.";
                }
            }

            chatForm.onsubmit = async (e) => {
                e.preventDefault();
                const t = userInput.value.trim();
                if (!t) return;
                addMessage(t, "user");
                userInput.value = "";
                showTyping();
                await new Promise((r) =>
                    setTimeout(r, 300 + Math.random() * 500),
                );
                const r = await generateReply(t);
                hideTyping();
                addMessage(r, "bot");
            };

            async function regenerate(i) {
                const msg = chats[currentChatIndex][i - 1]?.text;
                if (!msg) return;
                chats[currentChatIndex].splice(i, 1);
                renderChat();
                showTyping();
                await new Promise((r) =>
                    setTimeout(r, 300 + Math.random() * 500),
                );
                const r = await generateReply(msg);
                hideTyping();
                addMessage(r, "bot");
            }

            newChatBtn.onclick = newChat;

            window.addEventListener("load", () => {
                loadChats();
                (async () => {
                    try {
                        // point at your local model manifest
                        generator = await pipeline(
                            "text-generation",
                            "/chat/model/chat_model/model.json",
                        );
                        userInput.disabled = false;
                        sendBtn.disabled = false;
                        userInput.placeholder = "Type your message...";
                    } catch (err) {
                        console.error("Model load error:", err);
                        userInput.placeholder = "Failed to load model";
                    }
                })();
            });
        </script>
    </body>
</html>
