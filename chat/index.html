<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Static Chatbot Interface</title>
        <style>
            :root {
                --sidebar-bg: #202123;
                --main-bg: #343541;
                --header-bg: #202123;
                --input-bg: #40414f;
                --bot-bg: #444654;
                --user-bg: #11a37f;
                --text-color: #d1d5db;
                --sidebar-text: #ffffff;
                --placeholder: #8b8a8f;
            }
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            body {
                display: flex;
                height: 100vh;
                font-family: ui-sans-serif, system-ui, sans-serif;
                color: var(--text-color);
                background: var(--main-bg);
            }
            .sidebar {
                width: 260px;
                background: var(--sidebar-bg);
                display: flex;
                flex-direction: column;
            }
            .sidebar-header {
                height: 60px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 1rem;
                border-bottom: 1px solid #3e3f41;
            }
            .sidebar-header .title {
                font-size: 1rem;
                color: var(--sidebar-text);
                font-weight: bold;
            }
            .sidebar-header button {
                background: transparent;
                border: none;
                color: var(--sidebar-text);
                font-size: 1.5rem;
                cursor: pointer;
            }
            .chat-history {
                flex: 1;
                overflow-y: auto;
                padding: 0.5rem;
            }
            .history-item {
                padding: 0.5rem;
                margin: 0.25rem 0;
                border-radius: 4px;
                cursor: pointer;
                color: var(--sidebar-text);
                background: #2f2f31;
            }
            .history-item.active {
                background: #3e3f41;
            }
            .history-item:hover {
                background: #3e3f41;
            }
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
            }
            .main-header {
                height: 60px;
                background: var(--header-bg);
                display: flex;
                align-items: center;
                padding: 0 1rem;
                font-size: 1rem;
                color: var(--sidebar-text);
                border-bottom: 1px solid #3e3f41;
            }
            .main-body {
                flex: 1;
                overflow-y: auto;
                padding: 1rem;
                position: relative;
            }
            .welcome {
                text-align: center;
                margin-top: 2rem;
                color: var(--placeholder);
            }
            .chat-item {
                max-width: 70%;
                padding: 0.6rem 0.8rem;
                margin: 0.5rem 0;
                border-radius: 15px;
                line-height: 1.4;
                opacity: 0;
                transform: translateY(10px);
                transition:
                    opacity 0.3s ease,
                    transform 0.3s ease;
                position: relative;
            }
            .chat-item.visible {
                opacity: 1;
                transform: translateY(0);
            }
            .chat-item.bot {
                background: var(--bot-bg);
                color: #ffffff;
                align-self: flex-start;
            }
            .chat-item.user {
                background: var(--user-bg);
                color: #ffffff;
                align-self: flex-end;
            }
            .chat-item .regenerate {
                position: absolute;
                top: 4px;
                right: 8px;
                background: transparent;
                border: none;
                color: var(--placeholder);
                font-size: 0.9rem;
                cursor: pointer;
                opacity: 0;
                transition: opacity 0.2s;
            }
            .chat-item.bot:hover .regenerate {
                opacity: 1;
            }
            .input-container {
                padding: 0.5rem;
                border-top: 1px solid #3e3f41;
                background: var(--input-bg);
            }
            .input-container form {
                display: flex;
            }
            .input-container input[type="text"] {
                flex: 1;
                padding: 0.6rem 0.8rem;
                font-size: 0.95rem;
                border: none;
                border-radius: 4px;
                background: #55555d;
                color: var(--text-color);
            }
            .input-container input[type="text"]::placeholder {
                color: var(--placeholder);
            }
            .input-container button {
                margin-left: 0.5rem;
                padding: 0 1rem;
                font-size: 0.95rem;
                border: none;
                border-radius: 4px;
                background: #10a37f;
                color: #ffffff;
                cursor: pointer;
            }
            .input-container button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            #typing-indicator {
                display: flex;
                align-items: center;
                height: 24px;
                margin: 0.5rem;
            }
            .dot {
                width: 8px;
                height: 8px;
                margin: 0 2px;
                background: var(--placeholder);
                border-radius: 50%;
                opacity: 0.4;
                animation: blink 1s infinite;
            }
            .dot:nth-child(2) {
                animation-delay: 0.2s;
            }
            .dot:nth-child(3) {
                animation-delay: 0.4s;
            }
            @keyframes blink {
                0%,
                80%,
                100% {
                    opacity: 0.4;
                }
                40% {
                    opacity: 1;
                }
            }
            ::-webkit-scrollbar {
                width: 8px;
            }
            ::-webkit-scrollbar-track {
                background: var(--main-bg);
            }
            ::-webkit-scrollbar-thumb {
                background: #5a5a60;
                border-radius: 4px;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers/dist/transformers.min.js"></script>
    </head>
    <body>
        <div class="sidebar">
            <div class="sidebar-header">
                <span class="title">Chatbot</span>
                <button id="new-chat" title="New Chat">＋</button>
            </div>
            <div class="chat-history" id="chat-history-sidebar"></div>
        </div>
        <div class="main">
            <div class="main-header">Static Chatbot</div>
            <div class="main-body" id="main-body"></div>
            <div class="input-container">
                <form id="chat-form">
                    <input
                        type="text"
                        id="user-input"
                        placeholder="Loading model..."
                        disabled
                        autocomplete="off"
                    />
                    <button type="submit" id="send-btn" disabled>Send</button>
                </form>
            </div>
        </div>
        <script>
            let chats = [];
            let currentChatIndex = -1;
            let generator = null;
            const userInput = document.getElementById("user-input");
            const sendBtn = document.getElementById("send-btn");

            // Load and initialize the pipeline
            async function loadGenerator() {
                try {
                    console.log(
                        "Attempting to load model from: ./model/chat_model",
                    );
                    generator = await window.transformers.pipeline(
                        "text-generation",
                        "./model/chat_model",
                    );
                    console.log("Model loaded successfully:", generator);
                    // Enable input once model is ready
                    userInput.disabled = false;
                    sendBtn.disabled = false;
                    userInput.placeholder = "Type your message...";
                } catch (e) {
                    console.error("Error loading model:", e);
                    userInput.placeholder = "Failed to load model";
                }
            }
            loadGenerator();

            // Persistence
            function saveChats() {
                localStorage.setItem("chats", JSON.stringify(chats));
            }
            function loadChats() {
                const stored = localStorage.getItem("chats");
                if (stored) chats = JSON.parse(stored);
                if (!chats.length) newChat();
            }

            const chatForm = document.getElementById("chat-form");
            const mainBody = document.getElementById("main-body");
            const chatHistorySidebar = document.getElementById(
                "chat-history-sidebar",
            );
            const newChatBtn = document.getElementById("new-chat");

            function newChat() {
                chats.push([]);
                currentChatIndex = chats.length - 1;
                renderHistory();
                renderChat();
            }

            function renderHistory() {
                chatHistorySidebar.innerHTML = "";
                chats.forEach((_, idx) => {
                    const item = document.createElement("div");
                    item.classList.add("history-item");
                    if (idx === currentChatIndex) item.classList.add("active");
                    item.textContent = "Chat " + (idx + 1);
                    item.addEventListener("click", () => {
                        currentChatIndex = idx;
                        renderHistory();
                        renderChat();
                    });
                    chatHistorySidebar.appendChild(item);
                });
            }

            function renderChat() {
                mainBody.innerHTML = "";
                const session = chats[currentChatIndex];
                if (!session.length) {
                    const welcome = document.createElement("div");
                    welcome.classList.add("welcome");
                    welcome.textContent = "Welcome! Start typing to chat.";
                    mainBody.appendChild(welcome);
                } else {
                    session.forEach((msg, i) => {
                        const bubble = document.createElement("div");
                        bubble.classList.add("chat-item", msg.sender);
                        bubble.textContent = msg.text;
                        if (msg.sender === "bot") {
                            const btn = document.createElement("button");
                            btn.classList.add("regenerate");
                            btn.textContent = "↻";
                            btn.addEventListener("click", () => regenerate(i));
                            bubble.appendChild(btn);
                        }
                        mainBody.appendChild(bubble);
                        requestAnimationFrame(() =>
                            bubble.classList.add("visible"),
                        );
                    });
                }
                mainBody.scrollTop = mainBody.scrollHeight;
                saveChats();
            }

            function addMessage(text, sender) {
                chats[currentChatIndex].push({ text, sender });
                renderChat();
            }

            function showTyping() {
                const indicator = document.createElement("div");
                indicator.id = "typing-indicator";
                ["", "", ""].forEach(() => {
                    const dot = document.createElement("div");
                    dot.classList.add("dot");
                    indicator.appendChild(dot);
                });
                mainBody.appendChild(indicator);
                mainBody.scrollTop = mainBody.scrollHeight;
            }

            function hideTyping() {
                const ind = document.getElementById("typing-indicator");
                if (ind) ind.remove();
            }

            async function generateReply(text) {
                // If generator not ready, wait for it
                if (!generator) {
                    await loadGenerator();
                }
                try {
                    const outputs = await generator(text, {
                        max_new_tokens: 50,
                    });
                    return outputs[0]?.generated_text.trim();
                } catch (e) {
                    console.error("Generation error:", e);
                    return "Error generating response.";
                }
            }

            chatForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                const text = userInput.value.trim();
                if (!text) return;
                addMessage(text, "user");
                userInput.value = "";
                showTyping();
                const delay = 300 + Math.random() * 500;
                await new Promise((r) => setTimeout(r, delay));
                const reply = await generateReply(text);
                hideTyping();
                addMessage(reply, "bot");
            });

            async function regenerate(idx) {
                const session = chats[currentChatIndex];
                const userMsg = session[idx - 1]?.text;
                if (!userMsg) return;
                session.splice(idx, 1);
                renderChat();
                showTyping();
                const delay = 300 + Math.random() * 500;
                await new Promise((r) => setTimeout(r, delay));
                const reply = await generateReply(userMsg);
                hideTyping();
                addMessage(reply, "bot");
            }

            newChatBtn.addEventListener("click", newChat);
            window.addEventListener("load", loadChats);
        </script>
    </body>
</html>
