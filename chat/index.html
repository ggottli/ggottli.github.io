<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Chatbot</title>
        <style>
            :root {
                --bg: #0b1020;
                --panel: #12182b;
                --accent: #7c8cff;
                --accent-2: #18d3ff;
                --text: #e7ecff;
                --muted: #9aa3c7;
                --bubble-user: #1c2442;
                --bubble-bot: #0f2038;
                --radius: 14px;
                --shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
            }
            * {
                box-sizing: border-box;
            }
            body {
                margin: 0;
                background:
                    radial-gradient(
                        1200px 800px at 20% -10%,
                        #1b2a5a44,
                        transparent
                    ),
                    radial-gradient(
                        900px 700px at 110% 20%,
                        #0fc0ff22,
                        transparent
                    ),
                    var(--bg);
                color: var(--text);
                font:
                    16px/1.6 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Inter,
                    sans-serif;
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 18px;
            }
            .app {
                width: min(980px, 100%);
                height: 86vh;
                display: grid;
                grid-template-rows: auto 1fr auto;
                background: linear-gradient(180deg, #0e1430aa, #0e1430f0);
                border: 1px solid #24305b;
                border-radius: 18px;
                box-shadow: var(--shadow);
                overflow: hidden;
            }
            header {
                padding: 16px 18px;
                display: flex;
                align-items: center;
                gap: 14px;
                border-bottom: 1px solid #22305a;
                background: linear-gradient(90deg, #0d1331, #0f183b);
            }
            .logo {
                width: 34px;
                height: 34px;
                display: grid;
                place-items: center;
                border-radius: 10px;
                background: conic-gradient(
                    from 160deg,
                    #7c8cff,
                    #18d3ff,
                    #7c8cff
                );
                color: #0b1020;
                font-weight: 800;
                box-shadow: inset 0 0 20px #ffffffaa;
            }
            .title {
                font-weight: 700;
                letter-spacing: 0.3px;
            }
            .sub {
                color: var(--muted);
                font-size: 13px;
            }
            .chat {
                overflow: auto;
                padding: 20px 18px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .row {
                display: flex;
                align-items: flex-start;
                gap: 10px;
            }
            .row.user {
                flex-direction: row-reverse;
            }
            .avatar {
                width: 34px;
                height: 34px;
                border-radius: 50%;
                background: linear-gradient(135deg, #7c8cff, #18d3ff);
                box-shadow: var(--shadow);
            }
            .bubble {
                padding: 12px 14px;
                border-radius: var(--radius);
                max-width: 80%;
                border: 1px solid #26335e;
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
                white-space: pre-wrap;
                word-wrap: break-word;
            }
            .user .bubble {
                background: var(--bubble-user);
            }
            .bot .bubble {
                background: var(--bubble-bot);
            }
            .toolbar {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 12px;
                border-top: 1px solid #22305a;
                background: #0e1430;
            }
            .model {
                appearance: none;
                background: #0f1735;
                color: var(--text);
                border: 1px solid #2a3766;
                border-radius: 10px;
                padding: 8px 10px;
            }
            textarea {
                flex: 1;
                resize: none;
                min-height: 52px;
                max-height: 160px;
                border-radius: 12px;
                padding: 12px 14px;
                background: #0f1735;
                color: var(--text);
                border: 1px solid #2a3766;
                outline: none;
                box-shadow: inset 0 0 0 1px transparent;
                transition: box-shadow 0.2s ease;
            }
            textarea:focus {
                box-shadow: inset 0 0 0 1px var(--accent);
            }
            button {
                background: linear-gradient(
                    135deg,
                    var(--accent),
                    var(--accent-2)
                );
                color: #0b1020;
                font-weight: 700;
                border: none;
                padding: 10px 16px;
                border-radius: 12px;
                cursor: pointer;
                box-shadow: 0 10px 24px rgba(23, 175, 255, 0.25);
            }
            .small {
                font-size: 12px;
                color: var(--muted);
            }
            .controls {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .status {
                margin-left: auto;
                color: var(--muted);
                font-size: 12px;
            }
            .link {
                color: #9fd8ff;
                text-decoration: none;
                border-bottom: 1px dashed #4ba8ff33;
            }
            .hidden {
                display: none;
            }
        </style>
    </head>
    <body>
        <div class="app">
            <header>
                <div class="logo">AI</div>
                <div>
                    <div class="title">Chatbot</div>
                    <div class="sub">Ask anything.</div>
                </div>
                <div class="status" id="status">ready</div>
            </header>

            <main class="chat" id="chat"></main>

            <form class="toolbar" id="form">
                <select class="model" id="model">
                    <option value="openai/gpt-oss-20b:free" selected>
                        openai/gpt-oss-20b:free (free)
                    </option>
                    <option value="openai/gpt-oss-120b">
                        openai/gpt-oss-120b
                    </option>
                </select>
                <div class="controls small">
                    <label
                        ><input type="checkbox" id="stream" checked />
                        stream</label
                    >
                </div>
                <textarea id="input" placeholder="Ask me anythingâ€¦"></textarea>
                <button type="submit">Send</button>
            </form>
        </div>

        <script>
            /** CONFIG **/
            const PA_BACKEND = "https://ggottli.pythonanywhere.com"; // <- CHANGE THIS
            const ENDPOINT = `${PA_BACKEND}/api/chat`;

            /** UI helpers **/
            const el = (id) => document.getElementById(id);
            const chat = el("chat");
            const statusEl = el("status");
            const input = el("input");
            const modelSel = el("model");

            function addMessage(role, content) {
                const row = document.createElement("div");
                row.className = `row ${role}`;
                const avatar = document.createElement("div");
                avatar.className = "avatar";
                const bubble = document.createElement("div");
                bubble.className = `bubble ${role === "user" ? "user" : "bot"}`;
                bubble.textContent = content;
                row.appendChild(avatar);
                row.appendChild(bubble);
                chat.appendChild(row);
                chat.scrollTop = chat.scrollHeight;
                return bubble; // so we can stream append
            }

            function setStatus(t) {
                statusEl.textContent = t;
            }

            /** Persistence (simple) **/
            const HISTORY_KEY = "oss-chat-history";
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
            history.forEach((m) =>
                addMessage(m.role === "user" ? "user" : "bot", m.content),
            );

            function pushHistory(role, content) {
                history.push({ role, content });
                if (history.length > 100) history = history.slice(-100);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            }

            /** Networking **/
            async function send(messages, { stream, model }) {
                const body = JSON.stringify({ messages, stream, model });
                const res = await fetch(ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body,
                });

                if (!stream) {
                    const data = await res.json();
                    const msg =
                        data?.choices?.[0]?.message?.content ??
                        (data?.error?.detail || JSON.stringify(data));
                    return { done: true, text: msg };
                }

                // Stream: parse SSE "data: {json}"
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let partial = "";
                let done = false;
                return {
                    async read(onChunk) {
                        while (true) {
                            const { value, done: d } = await reader.read();
                            if (d) {
                                done = true;
                                break;
                            }
                            const chunk = decoder.decode(value, {
                                stream: true,
                            });
                            partial += chunk;
                            // Split into SSE lines
                            const lines = partial.split("\n");
                            partial = lines.pop() || "";
                            for (const line of lines) {
                                const trimmed = line.trim();
                                if (!trimmed.startsWith("data:")) continue;
                                const payload = trimmed.slice(5).trim();
                                if (!payload || payload === "[DONE]") continue;
                                try {
                                    const json = JSON.parse(payload);
                                    const delta =
                                        json?.choices?.[0]?.delta?.content ??
                                        "";
                                    if (delta) onChunk(delta);
                                } catch (e) {
                                    /* ignore parse blips */
                                }
                            }
                        }
                        return { done: true };
                    },
                };
            }

            /** Form handling **/
            document
                .getElementById("form")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const content = input.value.trim();
                    if (!content) return;

                    const model = modelSel.value;
                    const stream = el("stream").checked;

                    const userBubble = addMessage("user", content);
                    pushHistory("user", content);

                    input.value = "";
                    const botBubble = addMessage("bot", ""); // placeholder to stream into
                    setStatus("thinkingâ€¦");

                    const messages = buildChatMessages(content);

                    try {
                        if (stream) {
                            const s = await send(messages, {
                                stream: true,
                                model,
                            });
                            await s.read((delta) => {
                                botBubble.textContent += delta;
                            });
                            pushHistory("assistant", botBubble.textContent);
                            setStatus("ready");
                        } else {
                            const { text } = await send(messages, {
                                stream: false,
                                model,
                            });
                            botBubble.textContent = text;
                            pushHistory("assistant", text);
                            setStatus("ready");
                        }
                    } catch (err) {
                        botBubble.textContent = "Error contacting server.";
                        setStatus("error");
                        console.error(err);
                    }
                });

            function buildChatMessages(latestUserText) {
                // Rehydrate last ~10 messages for minimal context
                const msgs = [];
                const recent = history.slice(-10);
                for (const m of recent) {
                    msgs.push({
                        role: m.role === "user" ? "user" : "assistant",
                        content: m.content,
                    });
                }
                msgs.push({ role: "user", content: latestUserText });
                // You can also prepend a system prompt here if desired
                return msgs;
            }

            // UX: Enter to send; Shift+Enter for newline
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    document.querySelector("button[type=submit]").click();
                }
            });
        </script>
    </body>
</html>
